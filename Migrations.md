# Миграции Базы Данных (Flyway / Liquibase)

До этого момента в наших заметках мы упоминали настройку `spring.jpa.hibernate.ddl-auto=update`.  
Она говорит Hibernate: «Эй, посмотри на мои Java `@Entity`. Если в базе нет таких таблиц или колонок — создай их сам».

**Почему это УЖАСНО в реальном Продакшене?**
Представьте: вы решили переименовать поле `username` в `login`. Hibernate увидит это и просто... **удалит колонку `username` вместе с миллионом данных всех ваших пользователей**, и затем создаст пустую колонку `login`. Ваш бизнес уничтожен.

В реальной разработке таблицы в БД **никогда не изменяются автоматически кодом Java**. 
Для этого используются системы управления Миграциями (Flyway или Liquibase).

---

### 1. Что такое Миграции?
Миграции — это "Система контроля версий (Git) для Базы Данных".
Вы пишете SQL-скрипты описывающие структурные изменения (например, создание новой таблицы или переименование колонки). Инструмент (Flyway или Liquibase) выполняет эти скрипты строго по порядку.

---

### 2. Как работает Flyway?

Мы создаем папку в ресурсах проекта `src/main/resources/db/migration`. 
Внутри нее мы кладем файлы с очень строгими названиями:

- `V1__init_schema.sql` (Создаем таблицы users и roles)
- `V2__add_avatar_to_users.sql` (Добавляем колонку)
- `V3__insert_admin.sql` (Заполняем первого админа)

**Что делает Flyway, когда поднимается Spring Boot?**
1. Он идет в вашу базу данных (PostgreSQL) и создает там техническую табличку `flyway_schema_history`. В ней он хранит список скриптов, которые он уже когда-либо запускал.
2. Flyway заходит в папку `db/migration` и сканирует файлы.
3. Он сверяет файлы с таблицей в базе. 
4. Ага! Файл `V1` уже был запущен год назад. Файл `V2` был месяц назад. А вот файл `V3` — новый!
5. Flyway выполняет SQL внутри `V3` и ставит галочку в `flyway_schema_history`, что скрипт успешно отработал.

*С этого момента вы не можете изменять файл `V1` или `V2`. Если Flyway увидит, что текст внутри старого файла поменялся (хэш-сумма не совпадает), он остановит запуск сервера с ошибкой "Validation failed". База Данных неприкосновенна!*

---

### 3. Как подключить Flyway

В классном мире Spring Boot это безумно просто.

**1. Добавляем плагин/зависимость в `pom.xml`:**
```xml
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
```

**2. Насильно выключаем Hibernate-магию в `application.yml`:**
```yaml
spring:
  # Отключаем авто-генерацию таблиц из Entity. Теперь структура БД 100% ручная!
  jpa:
    hibernate:
      ddl-auto: validate # validate означает: "Только сверяет, совпадают ли Java классы с реальными таблицами"
    show-sql: true
    
  # Настроим Flyway
  flyway:
    enabled: true
    baseline-on-migrate: true # Если запускаем на уже существующей базе
```

**3. Пишем скрипт-миграцию SQL:**
Создаем файл: `src/main/resources/db/migration/V1__Create_user_table.sql`:

```sql
-- Прям чистый, настоящий SQL в зависимости от вашей БД (Postgres)
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL
);

-- Индекс для быстрого поиска при логине
CREATE INDEX idx_user_email ON users(email);
```

Файл `V2__Add_active_flag.sql` (через месяц):
```sql
ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT TRUE;
```

---

### 4. В чем разница между Flyway и Liquibase?

Два почти одинаковых инструмента, но с разным подходом.

| | Flyway | Liquibase |
| :--- | :--- | :--- |
| **Формат скриптов** | Чистый `SQL` | Описывается через `XML` (чаще всего) или `.yml` (реже) |
| **Преимущества** | Нативный SQL. Очень легко и быстро писать и читать разработчикам. | Скрипты XML "абстрактны" от БД. Если вы переезжаете с Oracle на MySQL, Liquibase сам переведет XML-структуру в правильный синтаксис нужной БД. |
| **Откат (Rollback)** | Только в платной (Pro) версии. | Есть в бесплатной. Позволяет писать rollback-скрипты (отменяющие старые). |
| **Кому подходит** | Небольшим и средним компаниям. Проектам, жестко "прибитым" к одной БД (Postgres). | Огромным Enterprise корпорациям (B2B SaaS), которые продают продукт клиентам с разным "зоопарком" Баз Данных. |

**Итог:** Для 95% проектов (где база Postgres выбрана раз и навсегда) **Flyway** — идеален, потому что писать чистый SQL намного быстрее, чем мучиться с бесконечными XML тегами Liquibase. И это гарантия того, что ваши данные никогда не удалятся непредсказуемой магией Hibernate.
